#!/bin/bash

function print_help() {
cat<<EOF
USAGE: mymplayer [OPTION]... [FILE]
       -a             output audio stream to spdif dts,ac3
       -b SID         set subtitle id
       -d DELAY       set delay time
       -h             print help message
       -m             play dvd media
       -r RESUME_FILE set log file for resume
       -s SEEK        set seek time
       -t             play mpeg2 ts file
       -u AID         set audio id
       -v VOLUME      set volume
EOF
exit
}

output=
quiet=
delay=
volume=
audio="-ao pulse"
media=
sid=
aid=
message_level=
tsprog=
ts_file=false
while getopts 'ab:d:hmr:s:tu:v:' opt;do
    case $opt in
        h)
            print_help
            ;;
        b)
            sid="-sid $OPTARG"
            ;;
        u)
            aid="-aid $OPTARG"
            ;;
        m)
            media=dvd:////dev/sr0
            ;;
        a)
            audio="-ao alsa:device=spdif -ac hwac3,hwdts,mp3,faad,ffflac,ffwmav2"
            ;;
        d)
            delay=" -delay $OPTARG "
            ;;
        r)
            output=" > $OPTARG"
            quiet=" -quiet "
            message_level=" -msglevel all=4 "
            ;;
        s)
            seek=" -ss $OPTARG "
            ;;
        t)
            ts_file=true
            ;;
        v)
            volume=" -volume $OPTARG "
            ;;
    esac
done
shift $(($OPTIND -1))

if [ -z "$media" -a ! -f "$1" ];then
    print_help 
fi

input=$(realpath $1)

if [ $ts_file = "true" ];then
    tsprog_id=$(ffmpeg -i $input 2>&1 | egrep '(Program|Stream)' | awk '
    {
        if ( $1 == "Program") {
            id = $2
        }
        if (match($0, "mpeg2video")) {
            print id
            exit
        }
    }')
    if [ -n "$tsprog_id" ];then
        tsprog=" -tsprog $tsprog_id "
    fi
fi


(

cd /home/mc/xdg-user-dirs/picture/mplayer
eval mplayer $media $quiet $seek $delay $volume \
-input nodefault-bindings -volstep 10 \
-nomouseinput -noconsolecontrols -nojoystick -noar \
-fs -geometry 960x540+0+50 -monitoraspect 16:9 \
-cache 500000 -cache-min 50 -cache-seek-min 10 \
-dr -vf pp=fast/ffmpegdeint,screenshot \
-vo gl:swapinterval=1 \
$tsprog $aid $sid $audio $message_level \
$input $output

)

# -autosync 30 -mc 2.0 \
# -vo gl:lscale=5:cscale=5:filter-strength=1.0:swapinterval=1:yuv=3 \
# -delay 0.1 \
# -vf pp=ffmpegdeint,screenshot \
# -delay -0.3 \
# -geometry 640x360+100+100 -monitoraspect 16:9 \
# -dr -vf pp=ac/ffmpegdeint,screenshot \
# -channels 6 \
