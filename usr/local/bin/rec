#!/bin/bash

if [ $# -lt 3 ];then
cat <<EOF
USAGE: rec channel time output [fifo]
EOF
exit 1
fi

channel=$1
time=$2
output=$3
fifo_param=
if [ $# -eq 4 ];then
    fifo_param=$4
fi

lock_dir=/tmp/dvb-pt1-adapter
mkdir -p $lock_dir
if [ $channel -gt 100 ];then
    lock_file=bs_cs
    adapter_1=/dev/dvb/adapter0
    adapter_2=/dev/dvb/adapter2
else
    lock_file=degital
    adapter_1=/dev/dvb/adapter1
    adapter_2=/dev/dvb/adapter3
fi

while [ -f ${lock_dir}/${lock_file} ];do
    sleep 1
done
touch ${lock_dir}/${lock_file}

adapter=$adapter_1
fuser -s $adapter/*
if [ $? -eq 0 ];then
    adapter=$adapter_2
    fuser -s $adapter/*
    if [ $? -eq 0 ];then
        /bin/rm -f ${lock_dir}/${lock_file}
        echo resource is busy
        exit 1
    fi
fi

/bin/rm -f ${lock_dir}/${lock_file}

####################################################################################################
# recording start
####################################################################################################

fifo_cat=/tmp/fifo_cat$$
mkfifo -m 644 $fifo_cat

id=$(echo $adapter | sed -e 's/[^0-9]//g')
tune $id $channel &
sleep 1
pid_tune=$!
touch $output
b25 -v 0 $fifo_cat $output &
pid_b25=$!
LANG=C cat ${adapter}/dvr0 > $fifo_cat &
pid_cat=$!
if [ -n "$fifo_param" ];then
    tail -f $output > $fifo_param &
    pid_tail=$!
fi

sleep $time

kill -TERM $pid_cat
kill -TERM $pid_tune
kill -TERM $pid_b25
/bin/rm -f $fifo_cat
if [ -n "$fifo_param" ];then
    kill -TERM $pid_tail
fi
