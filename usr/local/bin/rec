#!/bin/bash

function safe_finish() {
    sync
    kill -TERM $pid_dd
    kill -TERM $pid_tune
    /bin/rm -f $run_file
}

if [ $# -lt 3 ];then
cat <<EOF
USAGE: rec channel time output
EOF
exit 1
fi

channel=$1
time=$2
output=$3

if [ $channel -gt 100 ];then
    tuner=bs_cs
    aid_1=0
    aid_2=2
else
    tuner=degital
    aid_1=1
    aid_2=3
fi

work_dir=/tmp/dvb-pt2
run_dir=${work_dir}/run
fifo_dir=${work_dir}/fifo
lock_file=${work_dir}/adapter
mkdir -p $run_dir $fifo_dir

lockfile-create $lock_file
lockfile-touch $lock_file &
pid_lock=$!

aid=$aid_1
run_file=${run_dir}/${tuner}_${aid}
if [ -f $run_file ];then
    aid=$aid_2
    run_file=${run_dir}/${tuner}_${aid}
    if [ -f $run_file ];then
        echo "$0: resource is busy $(echo ${run_dir}/*)"
        kill -TERM $pid_lock
        lockfile-remove $lock_file
        exit 1
    fi
fi
touch $run_file
pcscd

kill -TERM $pid_lock
lockfile-remove $lock_file

####################################################################################################
# recording start
####################################################################################################
echo "$0: $run_file" 

tune $aid $channel &
pid_tune=$!
sleep 1
LANG=C dd if=/dev/dvb/adapter${aid}/dvr0 of=$output \
    ibs=4096 obs=4096 \
    oflag=noatime &
pid_dd=$!

trap safe_finish 1 2 3 15
sleep $time
safe_finish
