#!/bin/bash

function safe_finish() {
    sync
    kill -TERM $pid_dd
    kill -TERM $pid_tune
    /bin/rm -f $run_file
}

fuse=
extend_fifo=
while getopts 'e:f' opt;do
    case $opt in
        e)
            extend_fifo=$OPTARG
            ;;
        f)
            fuse=fuse_b25
            ;;
    esac
done
shift $(($OPTIND -1))

if [ $# -lt 3 ];then
cat <<EOF
USAGE: rec [OPTION] channel time output
       -e  specify extend rec time fifo
       -f  use fuse_b25
EOF
exit 1
fi

channel=$1
time=$2
output=$3

if [ $channel -gt 100 ];then
    tuner=bs_cs
    if [ "$fuse" = "fuse_b25" ];then
        aid_1=8
        aid_2=10
    else
        aid_1=0
        aid_2=2
    fi
else
    tuner=degital
    if [ "$fuse" = "fuse_b25" ];then
        aid_1=9
        aid_2=11
    else
        aid_1=1
        aid_2=3
    fi
fi

work_dir=/tmp/dvb-pt2
run_dir=${work_dir}/run
lock_file=${work_dir}/adapter
mkdir -p $run_dir

lockfile-create $lock_file
lockfile-touch $lock_file &
pid_lock=$!

aid=$aid_1
run_file=${run_dir}/${tuner}_${aid}
if [ -f $run_file ];then
    aid=$aid_2
    run_file=${run_dir}/${tuner}_${aid}
    if [ -f $run_file ];then
        echo "$0: resource is busy $(echo ${run_dir}/*)"
        kill -TERM $pid_lock
        lockfile-remove $lock_file
        exit 1
    fi
fi
touch $run_file

kill -TERM $pid_lock
lockfile-remove $lock_file

####################################################################################################
# recording start
####################################################################################################
echo "$0: $run_file" 

trap safe_finish 1 2 3 15

tid=$aid
if [ "$fuse" = "fuse_b25" ];then
    tid=$(($aid - 8))
fi
tune $tid $channel &
pid_tune=$!

sleep 1

LANG=C dd if=/dev/dvb/adapter${aid}/dvr0 of=$output \
    ibs=4096 obs=4096 \
    oflag=noatime &
pid_dd=$!

sleep $time
if [ -p "$extend_fifo" ];then
    time=$(cat $extend_fifo)
    if [ -n "$time" ];then
        sleep $time
    fi
fi

safe_finish
